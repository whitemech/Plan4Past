#!/usr/bin/env python3
import argparse
import datetime
import tempfile
from pathlib import Path

from bin.utils import MYND_WRAPPER_PATH, launch, SUPPORTED_PLANNERS, ALGORITHMS, HEURISTICS, FD_WRAPPER_PATH, \
    is_valid_file, PALADINUS_WRAPPER_PATH

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Wrapper for FOND4LTLfPLTLf.")
    parser.add_argument('-d', dest='domain_path', type=is_valid_file, required=True)
    parser.add_argument('-p', dest='problem_path', type=is_valid_file, required=True)
    parser.add_argument('-g', dest='goal', type=str, required=True)
    parser.add_argument('-t', dest='planner', type=str, choices=SUPPORTED_PLANNERS, required=True)
    parser.add_argument('-a', "--algorithm", dest='algorithm', type=str, choices=ALGORITHMS, required=True)
    parser.add_argument('--heuristic', dest='heuristic', type=str, choices=HEURISTICS, default="ff")
    parser.add_argument('--working-dir', dest='working_dir', type=str, default=None)
    args = parser.parse_args()

    if args.working_dir:
        working_dir = Path(args.working_dir)
        working_dir.mkdir()
    else:
        working_dir = Path(tempfile.mkdtemp())

    start = datetime.datetime.now()
    new_domain_file = working_dir / "new_domain.pddl"
    new_problem_file = working_dir / "new_problem.pddl"
    launch(["fond4ltlfpltlf",
            "-d", args.domain_path,
            "-p", args.problem_path,
            "-g", args.goal,
            "-outd", new_domain_file,
            "-outp", new_problem_file,
            ])
    end_compilation = datetime.datetime.now()
    elapsed_time_compilation = (end_compilation.timestamp() - start.timestamp())
    print(f"Compilation time: {elapsed_time_compilation} seconds")

    cli_args = []
    if args.planner == "mynd":
        cli_args = [str(MYND_WRAPPER_PATH),
                    "-d", str(new_domain_file),
                    "-p", str(new_problem_file),
                    "-a", str(args.algorithm),
                    "--heuristic", str(args.heuristic),
                    "--working-dir", str(working_dir)]
    elif args.planner == "paladinus":
        cli_args = [str(PALADINUS_WRAPPER_PATH),
                    "-d", str(new_domain_file),
                    "-p", str(new_problem_file),
                    "-a", str(args.algorithm),
                    "--heuristic", str(args.heuristic),
                    "--working-dir", str(working_dir)]
    elif args.planner == "fd":
        cli_args = [str(FD_WRAPPER_PATH),
                    "-d", str(new_domain_file),
                    "-p", str(new_problem_file),
                    "-a", str(args.algorithm),
                    "--heuristic", str(args.heuristic),
                    "--working-dir", str(working_dir)]
    else:
        raise ValueError
    launch(cli_args)
    end_tool = datetime.datetime.now()
    end_tool_time = end_tool - end_compilation
    print(f"Tool time: {end_tool_time.total_seconds()} seconds")
    elapsed = end_tool - start
    print(f"Total time: {elapsed.total_seconds()} seconds")
